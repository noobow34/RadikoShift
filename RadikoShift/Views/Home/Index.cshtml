@using RadikoShift.ViewModel
@model ProgramFilterViewModel

<div class="container-fluid">
    <h3 class="mb-3">🗓️ 番組表</h3>

    <!-- フィルタ -->
    <div class="row g-2 mb-3">
        <!-- 地区 -->
        <div class="col-4 col-md-3">
            <select id="region" class="form-select">
                <option value="">地区</option>
                @foreach (var s in Model.Reagions)
                {
                    <option value="@s.Id">@s.Name</option>
                }
            </select>
        </div>

        <!-- 局 -->
        <div class="col-4 col-md-3">
            <select id="station" class="form-select" disabled>
                <option value="">放送局</option>
                @foreach (var s in Model.Stations)
                {
                    <option value="@s.Id">@s.Name</option>
                }
            </select>
        </div>

        <!-- 日付 -->
        <div class="col-4 col-md-3">
            <input id="date"
                   type="date"
                   class="form-control"
                   min="@Model.MinDate"
                   max="@Model.MaxDate"
                   value="@DateTime.Today.ToString("yyyy-MM-dd")" />
        </div>
    </div>

    <!-- 番組表 -->
    <div id="program-table">
        <div class="text-center text-muted">
            条件を選択してください
        </div>
    </div>

</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="reserveToast" class="toast align-items-center text-bg-success border-0"
         role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                予約しました
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('#region').on('change', function () {
            const region = $(this).val();

            $('#station').prop('disabled', true).empty()
                .append('<option value="">放送局</option>');
            $('#program-table').empty();

            if (!region) return;

            $.getJSON('/Home/GetStations', { region: region })
                .done(function (data) {
                    $.each(data, function (_, s) {
                        $('#station').append(
                            $('<option>').val(s.id).text(s.name)
                        );
                    });
                    $('#station').prop('disabled', false);
                });
        });

        $('#station, #date').on('change', function () {
            const stationId = $('#station').val();
            const date = $('#date').val();

            if (!stationId || !date) return;

            $('#program-table').load(
                '/Home/ProgramTablePartial',
                { stationId: stationId, date: date }
            );
        });

                let selectedProgram = null;

        $(document).on('click', '.reserve-btn', function () {
            selectedProgram = {
                programId: $(this).data('program-id'),
                title: $(this).data('title'),
                time: $(this).data('time')
            };

            $('#modalTitle').text(selectedProgram.title);
            $('#modalTime').text(`${selectedProgram.time}`);

            // 初期状態
            $('.repeat-option').prop('checked', false);
            $('#repeatOnce').prop('checked', true);

            const modal = new bootstrap.Modal('#reserveModal');
            modal.show();
        });

        $(document).on('change', '.repeat-option', function () {
            $('.repeat-option').not(this).prop('checked', false);
            $(this).prop('checked', true);
        });

        $(document).on('click', '#confirmReserve', function () {

            const repeatType = $('.repeat-option:checked').val()

            const payload = {
                programId: $('#modalProgramId').val(),
                title: $('#modalTitle').val(),
                castName: $('#modalCast').val(),
                startTime: $('#modalStartTime').val(),
                endTime: $('#modalEndTime').val(),
                repeatType: repeatType,
                isEdited: $('#isEditedCheckbox').is(':checked')
            }

            $.post('/Reservation/Create', payload)
                .done(() => {

                    const toastEl = document.getElementById('reserveToast')
                    const toast = new bootstrap.Toast(toastEl, { delay: 2000 })
                    toast.show()

                    const modal = bootstrap.Modal.getInstance(
                        document.getElementById('reserveModal')
                    )
                    modal.hide()
                })
                .fail(() => alert('予約に失敗しました'))
        })

        $(document).on('click', '.reserve-btn', function () {
            const $btn = $(this)

            const timeRange = ($btn.data('time') || "")
            const parts = timeRange.split('–').map(x => x.trim())

            $('#modalStartTime').val(parts[0] || "")
            $('#modalEndTime').val(parts[1] || "")
            $('#modalTitle').val($btn.data('title') || "")
            $('#modalCast').val($btn.data('cast') || "")
            $('#modalProgramId').val($btn.data('program-id') || "")

            const modalEl = document.getElementById('reserveModal')
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl)
            modal.show()
        })

    </script>
}
