@using RadikoShift.EF
@model IEnumerable<RadikoShift.EF.Reservation>
<div class="container">
    <h3 class="mb-3">📻 予約一覧</h3>

    <div id="reservation-container">
        @await Html.PartialAsync("_ReservationList", Model)
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmCancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                この予約をキャンセルしますか？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">戻る</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtn">キャンセルする</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="appToast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto">通知</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

@functions {
    string RenderSchedule(Reservation r)
    {
        return r.RepeatType switch
        {
            RepeatType.Once =>
                $"{r.TargetDate:yyyy/MM/dd(ddd)} {r.StartTime:HH:mm} - {r.EndTime:HH:mm}",

            RepeatType.Daily =>
                $"毎日 {r.StartTime:HH:mm} - {r.EndTime:HH:mm}",

            RepeatType.Weekly =>
                $"毎週 {r.RepeatDays!.Value.ToJapanese()} {r.StartTime:HH:mm} - {r.EndTime:HH:mm}",

            _ => "-"
        };
    }
}

@section Scripts {
    <script>
        let cancelTargetId = null;

        $(document).on('click', '.cancel-btn', function () {
            cancelTargetId = $(this).data('id');
            const modal = new bootstrap.Modal(document.getElementById('confirmCancelModal'));
            modal.show();
        });

        $('#confirmCancelBtn').on('click', function () {
            if (!cancelTargetId) return;

            $.post('/Reservation/Cancel', { id: cancelTargetId })
                .done(function () {
                    showToast('予約をキャンセルしました');
                    reloadReservationList();
                })
                .fail(function () {
                    showToast('キャンセルに失敗しました');
                });

            cancelTargetId = null;
            bootstrap.Modal.getInstance(document.getElementById('confirmCancelModal')).hide();
        });

        function reloadReservationList() {
            $('#reservation-container').load('/Reservation/ListPartial');
        }

        function showToast(message) {
            $('#toastMessage').text(message);
            const toast = new bootstrap.Toast(document.getElementById('appToast'));
            toast.show();
        }
    </script>
}