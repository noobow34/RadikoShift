@using RadikoShift.EF
@model IEnumerable<RadikoShift.EF.Reservation>
<div class="container">
    <h3 class="mb-3">📻 予約一覧</h3>

    <div id="reservation-container">
        @await Html.PartialAsync("_ReservationList", Model)
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmCancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                この予約をキャンセルしますか？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">戻る</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtn">キャンセルする</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="appToast" class="toast text-bg-success border-0">
        <div class="toast-body"></div>
    </div>
</div>


<div class="modal fade" id="editReservationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">予約編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="editReservationId">

                <div class="mb-2 row align-items-center">
                    <label class="col-3 col-form-label">タイトル</label>
                    <div class="col-9">
                        <input class="form-control form-control-sm" id="editTitle">
                    </div>
                </div>

                <div class="mb-2 row align-items-center">
                    <label class="col-3 col-form-label">時間</label>
                    <div class="col-9 d-flex align-items-center gap-2">
                        <input type="time" class="form-control form-control-sm"
                               id="editStartTime" style="max-width:120px">
                        <span>～</span>
                        <input type="time" class="form-control form-control-sm"
                               id="editEndTime" style="max-width:120px">
                    </div>
                </div>

                <div class="mb-2 row align-items-center">
                    <label class="col-3 col-form-label">出演</label>
                    <div class="col-9">
                        <input class="form-control form-control-sm" id="editCast">
                    </div>
                </div>

                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="editIsEdited">
                    <label class="form-check-label small" for="editIsEdited">
                        手動編集として保存
                    </label>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button class="btn btn-primary" id="saveReservationEdit">
                    保存
                </button>
            </div>

        </div>
    </div>
</div>

@functions {
    string RenderSchedule(Reservation r)
    {
        return r.RepeatType switch
        {
            RepeatType.Once =>
                $"{r.TargetDate:yyyy/MM/dd(ddd)} {r.StartTime:HH:mm} - {r.EndTime:HH:mm}",

            RepeatType.Daily =>
                $"毎日 {r.StartTime:HH:mm} - {r.EndTime:HH:mm}",

            RepeatType.Weekly =>
                $"毎週 {r.RepeatDays!.Value.ToJapanese()} {r.StartTime:HH:mm} - {r.EndTime:HH:mm}",

            _ => "-"
        };
    }
}

@section Scripts {
    <script>
        let cancelTargetId = null;

        $(document).on('click', '.cancel-btn', function () {
            cancelTargetId = $(this).data('id');
            const modal = new bootstrap.Modal(document.getElementById('confirmCancelModal'));
            modal.show();
        });

        $('#confirmCancelBtn').on('click', function () {
            if (!cancelTargetId) return;

            $.post('/Reservation/Cancel', { id: cancelTargetId })
                .done(function () {
                    showToast('予約をキャンセルしました', 'success');
                    reloadReservationList();
                })
                .fail(function () {
                    showToast('キャンセルに失敗しました', 'danger');
                });

            cancelTargetId = null;
            bootstrap.Modal.getInstance(document.getElementById('confirmCancelModal')).hide();
        });

        function reloadReservationList() {
            $('#reservation-container').load('/Reservation/ListPartial');
        }

        function showToast(message, type) {
            const toastEl = document.getElementById('appToast');

            toastEl.classList.remove('text-bg-success', 'text-bg-danger');
            toastEl.classList.add(`text-bg-${type}`);

            toastEl.querySelector('.toast-body').textContent = message;

            new bootstrap.Toast(toastEl, { delay: 2000 }).show();
        }

        $(document).on('click', '.edit-reserve-btn', function () {

            const $btn = $(this)

            $('#editReservationId').val($btn.data('id'))
            $('#editTitle').val($btn.data('title'))
            $('#editCast').val($btn.data('cast'))
            $('#editStartTime').val($btn.data('start'))
            $('#editEndTime').val($btn.data('end'))
            $('#editIsEdited').prop('checked', $btn.data('edited'))

            const modal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById('editReservationModal')
            )
            modal.show()
        })


        $(document).on('click', '#saveReservationEdit', function () {

            const payload = {
                id: $('#editReservationId').val(),
                title: $('#editTitle').val(),
                castName: $('#editCast').val(),
                startTime: $('#editStartTime').val(),
                endTime: $('#editEndTime').val(),
                isEdited: $('#editIsEdited').is(':checked')
            }

            $.post('/Reservation/Update', payload)
                .done(function (html) {
                    $('#reservation-list').html(html)
                    const modal = bootstrap.Modal.getInstance(
                        document.getElementById('editReservationModal')
                    )
                    modal.hide()
                    showToast('予約を更新しました', 'success');
                })
                .fail(() => showToast('予約の更新に失敗しました', 'danger'))
        })

    </script>
}